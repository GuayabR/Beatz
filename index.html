<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Beatz 1.7.0</title>
    <link rel="icon" type="image/x-icon" href="Resources/favicon1.ico">
    <link rel="stylesheet" type="text/css" href="middleCanvas.css">
</head>
<body>
    <canvas id="myCanvas" width="1280" height="720">
        Your browser does not support the canvas element. Beatz.io can not start.
    </canvas>
    <h1>Beatz.io</h1>

    <button id="startButton">Start! (Enter)</button>
    <button onclick="NewTab()">My YouTube!</button>
    <button id="toggleNoteStyleButton">Toggle Note Style</button>
    <button id="previousButton" style="display: none;">Previous Song</button>
    <button id="restartButton" style="display: none;">Restart Song</button>
    <button id="nextButton" style="display: none;">Next Song</button>
    <button id="toggleAutoHit" style="display: none;">Toggle Auto Hit</button>
    <button id="fullscreen" onclick="toggleFullScreen()">Fullscreen</button>
    <button id="keybindsButton">Settings (Beta)</button>
    

    <!-- The Modal -->
    <div id="keybindsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <button id="resetKeybindsButton" class="reset-keybinds-button">&#x21bb;</button>
                <button id="redoKeybindsButton" class="redo-keybinds-button">&#x21aa;</button>
                <button id="undoKeybindsButton" class="undo-keybinds-button">&#x21a9;</button>
            <h2>Customize Settings!</h2>
            <form id="keybindsForm">
                <label for="up">Note Left:</label>
                <input type="text" id="left" name="left"><br><br>
                <label for="left">Note Up:</label>
                <input type="text" id="up" name="up"><br><br>
                <label for="down">Note Down:</label>
                <input type="text" id="down" name="down"><br><br>
                <label for="right">Note Right:</label>
                <input type="text" id="right" name="right"><br><br>
                <label for="pause">Pause Game:</label>
                <input type="text" id="pause" name="pause"><br><br>
                <label for="previousInput">Previous Song:</label>
                <input type="text" id="previousInput" name="previous"><br><br>
                <label for="restartInput">Restart Song:</label>
                <input type="text" id="restartInput" name="restart"><br><br>
                <label for="nextButton">Next Song:</label>
                <input type="text" id="nextInput" name="next"><br><br>
                <label for="randomize">Randomize Song:</label>
                <input type="text" id="randomize" name="randomize"><br><br>
                <label for="toggleNoteStyleInput">Toggle Note Style:</label>
                <input type="text" id="toggleNoteStyleInput" name="toggleNoteStyle"><br><br>
                <span id="settingsSaved" style="color: white; display: none;">Settings saved!</span>
                <span id="settingsSaved01" style="color: white; display: none;">(Reload browser)</span>
                <button type="button" onclick="saveKeybinds()">Save</button>
            </form>
        </div>
    </div>

    <h3>Each perfect note you hit equals 1 point, each early or late equals a half point. Each missed note decreases your score by 1 point</h3>
    <h2>Background image from: <a href="https://github.com/Uproxide/Texture-Workshop/commit/457788213d900a980f559ae8f241febad3322bdd#diff-1dbd3c28454ab3b1596af576394661ba03597f51326dbbff288c6b8ccc353041">Uproxide's "Texture Workshop"</a></h2>
    <h2>Notes from: <a href="https://github.com/Simply-Love/Simply-Love-SM5?tab=readme-ov-file">Teejusb's "Simply Love" osu! mania skins</a></h2>
    <h2><a href="https://www.youtube.com/watch?v=tOZNh8veU_Y">Song list (40 songs)</a></h2>

    <script>
        var canvas = document.getElementById('myCanvas');
        document.addEventListener("DOMContentLoaded", function() {
            loadKeybinds();
            updateKeybindsFields();
        });

        document.getElementById('undoKeybindsButton').addEventListener('click', undoKeybinds);
        document.getElementById('redoKeybindsButton').addEventListener('click', redoKeybinds);

        let keybindsHistory = [];
        let keybindsIndex = -1;

        function NewTab() {
            window.open("https://www.youtube.com/@GuayabR", "_blank");
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener('keypress', function(event) {
            if (event.key === 'F' || event.key === 'f') {
                toggleFullScreen();
            }
        });

        document.addEventListener('fullscreenchange', function() {
            if (document.fullscreenElement) {
                canvas.style.cursor = 'none';
            } else {
                canvas.style.cursor = 'default';
            }
        });

        var modal = document.getElementById("keybindsModal");
        var btn = document.getElementById("keybindsButton");
        var span = document.getElementsByClassName("close")[0];
        var resetButton = document.getElementById("resetKeybindsButton");
        const saveMessage = document.getElementById("settingsSaved"); 
        const saveMessage01 = document.getElementById("settingsSaved01");

        function convertToLowerCase(inputElement) {
            inputElement.value = inputElement.value.toLowerCase();
        }
        document.querySelectorAll('input[type="text"]').forEach(function(input) {
            input.addEventListener('input', function() {
                convertToLowerCase(input);
                hideSaveMessage();
            });
        });

        function hideSaveMessage() {
            saveMessage.style.display = 'none';
            saveMessage01.style.display = 'none';
        }

        btn.onclick = function() {
            openModal();
        }

        span.onclick = function() {
            modal.style.display = "none";
            document.getElementById("settingsSaved").style.display = "none";
            document.getElementById("settingsSaved01").style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        resetButton.onclick = function() {
            resetKeybinds();
        }

        function openModal() {
            modal.style.display = "block";
            loadKeybinds();
            deactivateKeybinds();
        }

        function closeModal() {
            modal.style.display = "none";
            saveMessage.style.display = "none";
            saveMessage01.style.display = "none";
            activateKeybinds();
        }

        document.addEventListener("keydown", function(event) {
            if (event.key === "p" || event.key === "P") {
                openModal();
            }
            if (event.key === "Escape") {
                closeModal();
            }
        });

        function deactivateKeybinds() {
            document.removeEventListener("keydown", keyDownFunction);
            document.removeEventListener("keyup", keyUpFunction);
        }

        function activateKeybinds() {
            document.addEventListener("keydown", keyDownFunction);
            document.addEventListener("keyup", keyUpFunction);
        }

        const defaultKeybinds = {
            up: ["w"],
            left: ["a"],
            down: ["s"],
            right: ["d"],
            pause: ["escape"],
            autoHit: ["1"],
            previous: ["q"],
            restart: ["r"],
            next: ["e"],
            randomize: ["t"],
            toggleNoteStyle: ["c"],
        };

        let keybinds = { ...defaultKeybinds };

        function loadKeybinds() {
            const savedKeybinds = JSON.parse(localStorage.getItem('keybinds'));
            if (savedKeybinds) {
                keybinds = savedKeybinds;
            }
            document.getElementById('up').value = keybinds.up.join(", ");
            document.getElementById('left').value = keybinds.left.join(", ");
            document.getElementById('down').value = keybinds.down.join(", ");
            document.getElementById('right').value = keybinds.right.join(", ");
            document.getElementById('pause').value = keybinds.pause.join(", ");
            document.getElementById('previousInput').value = keybinds.previous.join(", ");
            document.getElementById('restartInput').value = keybinds.restart.join(", ");
            document.getElementById('nextInput').value = keybinds.next.join(", ");
            document.getElementById('randomize').value = keybinds.randomize.join(", ");
            document.getElementById('toggleNoteStyleInput').value = keybinds.toggleNoteStyle.join(", ");
        }

        function saveKeybinds() {
            const newKeybinds = {
                up: document.getElementById('up').value.split(", "),
                left: document.getElementById('left').value.split(", "),
                down: document.getElementById('down').value.split(", "),
                right: document.getElementById('right').value.split(", "),
                pause: document.getElementById('pause').value.split(", "),
                previous: document.getElementById('previousInput').value.split(", "),
                restart: document.getElementById('restartInput').value.split(", "),
                next: document.getElementById('nextInput').value.split(", "),
                randomize: document.getElementById('randomize').value.split(", "),
                toggleNoteStyle: document.getElementById('toggleNoteStyleInput').value.split(", "),
            };
            if (JSON.stringify(newKeybinds) === JSON.stringify(keybinds)) {
                // No changes have been made
                saveMessage.textContent = "No changes have been made.";
                saveMessage.style.display = 'block';
                saveMessage01.style.display = 'none';
            } else {
                // Changes have been made
                keybinds = newKeybinds;
                localStorage.setItem('keybinds', JSON.stringify(keybinds));

                keybindsHistory.push({ ...keybinds });
                keybindsIndex = keybindsHistory.length - 1;

                saveMessage.textContent = "Settings saved!";
                saveMessage.style.display = 'block';
                saveMessage01.style.display = 'block';
            }
        }

        function resetKeybinds() {
            for (let key in defaultKeybinds) {
                const inputField = document.getElementById(key);
            if (inputField) {
                inputField.value = defaultKeybinds[key].join(', ');
                }
            }
            saveKeybinds();
            loadKeybinds();
        }

        function undoKeybinds() {
            if (keybindsIndex > 0) {
                keybindsIndex--;
                keybinds = { ...keybindsHistory[keybindsIndex] };
                updateKeybindsFields();
            }
        }

        function redoKeybinds() {
            if (keybindsIndex < keybindsHistory.length - 1) {
                keybindsIndex++;
                keybinds = { ...keybindsHistory[keybindsIndex] };
                updateKeybindsFields();
            }
        }

        function updateKeybindsFields() {
            document.getElementById('up').value = keybinds.up.join(", ");
            document.getElementById('left').value = keybinds.left.join(", ");
        }

        function keyDownFunction(keyboardEvent) {
            var keyDown = keyboardEvent.key.toLowerCase();
            console.log("Pressed:", keyDown);

            if (!gameStarted) {
                if (keyDown == "enter") {
                    document.getElementById("startButton").click();
                    gameStarted = true;
                }
                return;
            }

            if (gameStarted && keyDown == "enter") {
                return;
            }

            if (keybinds.up.includes(keyDown)) {
                upPressed = true;
            }
            if (keybinds.left.includes(keyDown)) {
                leftPressed = true;
            }
            if (keybinds.down.includes(keyDown)) {
                downPressed = true;
            }
            if (keybinds.right.includes(keyDown)) {
                rightPressed = true;
            }
            if (keybinds.pause.includes(keyDown)) {
                togglePause();
            }
            if (keybinds.previous.includes(keyDown)) {
                previousSong();
            }
            if (keybinds.restart.includes(keyDown)) {
                restartSong();
            }
            if (keybinds.next.includes(keyDown)) {
                nextSong();
            }
            if (keybinds.randomize.includes(keyDown)) {
                randomizeSong();
            }
            if (keybinds.toggleNoteStyle.includes(keyDown)) {
                switchImage(noteLeftIMG, 'NoteLeftHQ.png', 'CircleLeftHQ.png');
                switchImage(noteDownIMG, 'NoteDownHQ.png', 'CircleDownHQ.png');
                switchImage(noteUpIMG, 'NoteUpHQ.png', 'CircleUpHQ.png');
                switchImage(noteRightIMG, 'NoteRightHQ.png', 'CircleRightHQ.png');
                switchImage(noteLeftPressIMG, 'NoteLeftPressHQ.png', 'CircleLeftPressHQ.png');
                switchImage(noteDownPressIMG, 'NoteDownPressHQ.png', 'CircleDownPressHQ.png');
                switchImage(noteUpPressIMG, 'NoteUpPressHQ.png', 'CircleUpPressHQ.png');
                switchImage(noteRightPressIMG, 'NoteRightPressHQ.png', 'CircleRightPressHQ.png');
                console.log("Changed textures");
                draw();
            }
        }

        function keyUpFunction(keyboardEvent) {
            var keyUp = keyboardEvent.key.toLowerCase();
            console.log("Released:", keyUp);

            if (keybinds.up.includes(keyUp)) {
                upPressed = false;
            }
            if (keybinds.left.includes(keyUp)) {
                leftPressed = false;
            }
            if (keybinds.down.includes(keyUp)) {
                downPressed = false;
            }
            if (keybinds.right.includes(keyUp)) {
                rightPressed = false;
            }
        }

        document.addEventListener("keydown", keyDownFunction);
        document.addEventListener("keyup", keyUpFunction);

    </script>
    <script src="BeatzGame.js"></script>
</body>
</html>
